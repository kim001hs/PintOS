name: Pintos Test CI

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  test:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install QEMU and build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            gcc \
            g++ \
            make \
            perl \
            python3
          
          if [ -f /usr/bin/qemu-system-i386 ]; then
            sudo ln -sf /usr/bin/qemu-system-i386 /usr/bin/qemu
          elif [ -f /usr/bin/qemu-system-x86_64 ]; then
            sudo ln -sf /usr/bin/qemu-system-x86_64 /usr/bin/qemu
          fi
          
          qemu --version

      - name: Activate Pintos environment
        shell: bash
        run: |
          source ./activate
          echo "$GITHUB_WORKSPACE/utils" >> "$GITHUB_PATH"

      - name: Run Pintos tests with detailed results
        env:
          PINTOSOPTS: -v
        run: |
          set +e
          
          # projects=(threads)
          projects=(user_prog)
          projects=(threads, user_prog, vm, filesys)
          
          echo "## ðŸ§ª Pintos Test Results" > test-summary.md
          echo "" >> test-summary.md
          echo "**Commit:** \`${{ github.event.pull_request.head.sha }}\`" >> test-summary.md
          echo "" >> test-summary.md
          
          grand_pass=0
          grand_total=0

          for project in "${projects[@]}"; do
            echo "::group::Testing $project"
            
            if [ -d "$project" ]; then
              cd "$project"
              
              make clean
              if ! make; then
                echo "### âŒ $project - Build Failed" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
                cd "$GITHUB_WORKSPACE"
                echo "::endgroup::"
                continue
              fi
              
              cd build
              make check VERBOSE=1 || true
              
              result_files=$(find tests -name '*.result' 2>/dev/null | sort)
              total=$(echo "$result_files" | wc -l | tr -d ' ')
              
              if [ "$total" -eq 0 ]; then
                echo "### âš ï¸ $project - No Tests Found" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
              else
                pass=0
                fail=0
                
                echo "### ðŸ“ $project" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "<details>" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "<summary><b>Test Cases ($total total)</b> - Click to expand</summary>" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
                
                for result_file in $result_files; do
                  test_name=$(basename "$result_file" .result)
                  if grep -q "PASS" "$result_file" 2>/dev/null; then
                    echo "- âœ… \`$test_name\`" >> "$GITHUB_WORKSPACE/test-summary.md"
                    pass=$((pass + 1))
                  else
                    echo "- âŒ \`$test_name\`" >> "$GITHUB_WORKSPACE/test-summary.md"
                    fail=$((fail + 1))
                  fi
                done
                
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "</details>" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
                
                pass_rate=$(awk "BEGIN {printf \"%.1f%%\", ($pass/$total)*100}")
                echo "**Summary:** $pass / $total passed ($pass_rate)" >> "$GITHUB_WORKSPACE/test-summary.md"
                echo "" >> "$GITHUB_WORKSPACE/test-summary.md"
                
                grand_pass=$((grand_pass + pass))
                grand_total=$((grand_total + total))
              fi
              
              cd "$GITHUB_WORKSPACE"
            fi
            
            echo "::endgroup::"
          done

          if [ "$grand_total" -gt 0 ]; then
            grand_pass_rate=$(awk "BEGIN {printf \"%.1f%%\", ($grand_pass/$grand_total)*100}")
            echo "---" >> test-summary.md
            echo "" >> test-summary.md
            echo "## ðŸ“Š Overall Results" >> test-summary.md
            echo "" >> test-summary.md
            echo "**${grand_pass} / ${grand_total}** tests passed (${grand_pass_rate})" >> test-summary.md
          fi
          
          echo "" >> test-summary.md
          echo "_Last updated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')_" >> test-summary.md
          
          cat test-summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'ðŸ§ª Pintos Test Results'

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: test-summary.md
          edit-mode: replace

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pintos-test-results
          path: |
            */build/tests/**/*.output
            */build/tests/**/*.result
            test-summary.md
          retention-days: 7